<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quizzone | Owner Message PDF</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<!-- jsPDF for creating downloadable PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
    margin: 0;
    background: #eef3ff;
    font-family: "Segoe UI", Arial;
}
.viewer {
    max-width: 950px;
    margin: 70px auto;
    background: #fff;
    padding: 25px;
    border-radius: 14px;
    box-shadow: 0 3px 20px rgba(0,0,0,0.2);
}
canvas {
    width: 100%;
    margin-bottom: 25px;
    border-radius: 12px;
    border: 1px solid #ccc;
}
button {
    padding: 12px 18px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}
button:hover { background:#005fcc; }

.print-hide {
    display: inline-block;
}
</style>
<script src="/Quizzone/Global/seoMeta.js"></script>
</head>
<body>

<div class="viewer">
    <h2 class="print-hide">ðŸ“„ Quizzone Owner Message</h2>
    <div id="pdfPages"></div>

    <button class="print-hide" onclick="printPDF()">Print PDF</button>
    <button class="print-hide" onclick="downloadTrademarkPDF()">Download PDF</button>
</div>

<script>
const url = "/Quizzone/Documentary/Quizzone_Owner_Message.pdf";

// ---------------- ACTIVE USER OR GUEST ----------------
let user = JSON.parse(localStorage.getItem("ActiveQuizzoneUser")) || {
    username: "Guest User",
    email: "guest@quizzone.com",
    contact: "N/A"
};

// ---------- LOAD MULTI-PAGE PDF ----------
pdfjsLib.getDocument(url).promise.then(async pdf => {
    const total = pdf.numPages;

    for (let pageNum = 1; pageNum <= total; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 1.45 });

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        canvas.width = viewport.width;
        canvas.height = viewport.height;

        document.getElementById("pdfPages").appendChild(canvas);

        await page.render({ canvasContext: ctx, viewport }).promise;

        applyWatermark(ctx, canvas, pageNum, total);
    }
});


// ============== ðŸ”µ APPLY WATERMARK & FOOTER ==============
function applyWatermark(ctx, canvas, pageNum, totalPages) {
    // diagonal watermark
    ctx.save();
    ctx.font = "bold 30px Segoe UI";
    ctx.fillStyle = "rgba(0,0,255,0.10)";
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.rotate(-0.35);
    ctx.textAlign = "center";
    ctx.fillText("Quizzone â€¢ Official Document", 0, 0);
    ctx.restore();

    // user info watermark
    ctx.font = "bold 16px Segoe UI";
    ctx.fillStyle = "rgba(255,0,0,0.5)";
    ctx.fillText(`User: ${user.username}`, 20, 40);
    ctx.fillText(`Email: ${user.email}`, 20, 65);
    ctx.fillText(`Contact: ${user.contact}`, 20, 90);

    // footer page number
    let code = pageNum.toString().padStart(3, "0");
    ctx.font = "bold 14px Segoe UI";
    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.fillText(`Â©Quizzone-${user.email}-${code}`, 20, canvas.height - 20);
}


// ============== ðŸ”µ PRINT PDF FUNCTION ==============
function printPDF() {
    // hide UI
    document.querySelectorAll(".print-hide").forEach(e => e.classList.add("printHide"));

    // print each canvas on separate page
    const CSS = `
        @media print {
            body { visibility: hidden; }
            #pdfPages { visibility: visible; }
            canvas { page-break-after: always; margin-bottom: 50px; }
        }
    `;

    const style = document.createElement("style");
    style.innerHTML = CSS;
    document.head.appendChild(style);

    window.print();

    // restore UI after printing
    document.querySelectorAll(".print-hide").forEach(e => e.classList.remove("printHide"));
}



// ============== ðŸ”µ DOWNLOAD REGENERATED PDF WITH WATERMARK ==============
async function downloadTrademarkPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: "px", format: "a4" });

    const pages = document.querySelectorAll("#pdfPages canvas");

    for (let i = 0; i < pages.length; i++) {
        const canvas = pages[i];
        const imgData = canvas.toDataURL("image/png");

        if (i !== 0) pdf.addPage();

        // fit into A4
        let width = 450; 
        let height = (canvas.height / canvas.width) * 480;

        pdf.addImage(imgData, "PNG", 0, 0, width, height);

        // footer watermark
        let code = (i+1).toString().padStart(3, "0");
        pdf.setFontSize(10);
        pdf.text(`Â©Quizzone-${user.email}-${code}`, 20, 825);
    }

    pdf.save("Quizzone_Owner_Message.pdf");
}
</script>

</body>
</html>
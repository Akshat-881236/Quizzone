<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QuizzoneAI</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --accent:#2B59FF;
  --accent2:#4F7BFF;
  --bg:#F5F7FF;
  --text:#0F172A;
  --muted:#6B7280;
}
*{box-sizing:border-box;font-family:"Segoe UI",Arial}
body{margin:0;background:var(--bg);color:var(--text)}

header{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#fff;padding:14px;
  text-align:center;font-size:22px;font-weight:700;
  position:sticky;top:0;z-index:10;
}

.container{
  display:grid;
  grid-template-columns:260px 1fr 320px;
  gap:16px;padding:16px;
}
@media(max-width:900px){
  .container{grid-template-columns:1fr}
}

.panel{
  background:#fff;
  padding:14px;
  border-radius:14px;
  box-shadow:0 4px 14px rgba(0,0,0,.1);
}

/* HISTORY */
.history-item{
  background:#f1f4ff;
  padding:10px;
  border-radius:10px;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  cursor:pointer;
}
.history-actions button{
  background:none;border:none;cursor:pointer;
}

/* CHAT */
#chatWindow{
  height:60vh;overflow-y:auto;
  border:1px solid #e3e8ff;
  padding:10px;border-radius:10px;
}
.msg{
  margin-bottom:14px;
  padding:10px;border-radius:12px;
  max-width:80%;position:relative;
  white-space:pre-wrap;
}
.user{background:#dce7ff;margin-left:auto}
.ai{background:#fff;border:1px solid #cfd6ff}

.msg-tools{
  position:absolute;top:-8px;right:6px;
  display:flex;gap:5px;
}
.msg-tools button{
  font-size:11px;border:none;
  background:#eef2ff;cursor:pointer;
}

.inputBar{display:flex;gap:8px;margin-top:8px}
input{flex:1;padding:10px;border-radius:10px;border:1px solid #ccd6ff}
.btn{
  background:var(--accent);color:#fff;
  padding:10px;border:none;border-radius:10px;
  cursor:pointer;
}

/* CODE */
.codeBox{
  background:#0f172a;color:#e5e7eb;
  padding:12px;border-radius:10px;
  margin-top:10px;position:relative;
}
.codeTools{
  position:absolute;top:6px;right:6px;
}
.codeTools button{
  font-size:11px;margin-left:4px;cursor:pointer;
}

/* PREVIEW */
iframe{
  width:100%;height:60vh;
  border:1px solid #ccd6ff;border-radius:10px;
}
</style>
<script src="/Quizzone/Global/loader.js"></script>
</head>

<body>
<header>QuizzoneAI</header>

<div class="container">

<!-- HISTORY -->
<aside class="panel">
  <h3>Chats</h3>
  <button class="btn" onclick="newChat()">+ New Chat</button>
  <div id="historyList"></div>
</aside>

<!-- CHAT -->
<section class="panel">
  <h3>Chat</h3>

  <div id="intro"></div>

  <div id="chatWindow"></div>
  <div class="inputBar">
    <input id="chatInput" placeholder="Ask Quizzone AI...">
    <button class="btn" id="sendBtn" onclick="sendMessage()">Send</button>
  </div>
</section>

<!-- PREVIEW -->
<aside class="panel">
  <h3>Preview / Run</h3>
  <iframe id="previewFrame"></iframe>
</aside>

</div>

<script>
/* ===============================
   API KEY (UNCHANGED)
================================ */
const PART1="sk-svcacct-1bXYaWfnuaoCOjTByMxkXyGOT8aVmosQRyzfW-";
const PART2="KoAHXZ2JjuV14PCiYCz6pyB-f-1oQWfQDR3wT3BlbkFJtWDjmN_SlK6LYUtNJWOliwuQEr";
const PART3="nSMks8QQvSwnPJZOWt1VqqaEN-pBYJOHcL5R6cHSg5Sz62IA";
const getAPIKey=()=>PART1+PART2+PART3;

/* ===============================
   STATE
================================ */
let chats=JSON.parse(localStorage.getItem("quizChats")||"[]");
let activeChat=null;
let messages=[];
let streaming=false;
const codeVersions={};

/* ===============================
   INTRO PROMPTS
================================ */
const introQ=[
 "Explain step by step",
 "Generate MCQs",
 "Create revision notes",
 "Give real-world example",
 "Make a quiz"
];
const introDiv=document.getElementById("intro");
introQ.forEach(q=>{
  const b=document.createElement("button");
  b.className="btn";b.innerText=q;
  b.onclick=()=>chatInput.value=q;
  introDiv.appendChild(b);
});

/* ===============================
   CHAT HISTORY
================================ */
function saveChats(){
  localStorage.setItem("quizChats",JSON.stringify(chats));
  renderHistory();
}
function newChat(){
  const title=prompt("Chat title?");
  if(!title) return;
  const pass=prompt("Password (optional)");
  const chat={
    id:"c"+Date.now(),
    title,
    pass:pass?btoa(pass):null,
    messages:[]
  };
  chats.push(chat);
  saveChats();
}
function renderHistory(){
  const h=document.getElementById("historyList");
  h.innerHTML="";
  chats.forEach(c=>{
    const d=document.createElement("div");
    d.className="history-item";
    d.innerHTML=`
      <span>${c.title}</span>
      <div class="history-actions">
        <button onclick="renameChat('${c.id}')">‚úè</button>
        <button onclick="exportChat('${c.id}')">üì§</button>
        <button onclick="deleteChat('${c.id}')">üóë</button>
      </div>`;
    d.onclick=()=>openChat(c.id);
    h.appendChild(d);
  });
}
function openChat(id){
  const c=chats.find(x=>x.id===id);
  if(c.pass){
    const p=prompt("Password?");
    if(btoa(p)!==c.pass) return alert("Wrong password");
  }
  activeChat=c;
  messages=c.messages;
  renderChat();
}
function renameChat(id){
  const c=chats.find(x=>x.id===id);
  const n=prompt("New title",c.title);
  if(n){c.title=n;saveChats();}
}
function deleteChat(id){
  chats=chats.filter(x=>x.id!==id);
  saveChats();
}
function exportChat(id){
  const c=chats.find(x=>x.id===id);
  const blob=new Blob([JSON.stringify(c,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=c.title+".json";a.click();
}
renderHistory();

/* ===============================
   CHAT RENDER
================================ */
function renderChat(){
  const w=document.getElementById("chatWindow");
  w.innerHTML="";
  messages.forEach((m,i)=>{
    const d=document.createElement("div");
    d.className="msg "+m.role;
    d.innerHTML=`
      ${parseMessage(m.content)}
      <div class="msg-tools">
        <button onclick="copyMsg(${i})">üìã</button>
        <button onclick="regenMsg(${i})">‚ôª</button>
        <button onclick="delMsg(${i})">üóë</button>
      </div>`;
    w.appendChild(d);
  });
  w.scrollTop=w.scrollHeight;
}
function copyMsg(i){navigator.clipboard.writeText(messages[i].content);}
function delMsg(i){messages.splice(i,1);renderChat();}
function regenMsg(i){chatInput.value=messages[i-1]?.content||"";}

/* ===============================
   CODE BOX
================================ */
function parseMessage(t){
  return t.replace(/```([\s\S]*?)```/g,(m,c)=>renderCode(c));
}
function renderCode(code){
  const id="code"+Date.now();
  codeVersions[id]=[code];
  return `
<div class="codeBox" id="${id}">
  <div class="codeTools">
    <button onclick="copyCode('${id}')">üìã</button>
    <button onclick="runCode('${id}')">‚ñ∂</button>
    <button onclick="editCode('${id}')">‚úè</button>
    <button onclick="prevCode('${id}')">‚è™</button>
  </div>
<pre>${code.replace(/</g,"&lt;")}</pre>
</div>`;
}
function copyCode(id){
  navigator.clipboard.writeText(
    document.querySelector("#"+id+" pre").innerText
  );
}
function runCode(id){
  previewFrame.srcdoc=
    document.querySelector("#"+id+" pre").innerText;
}
function editCode(id){
  const p=document.querySelector("#"+id+" pre");
  codeVersions[id].push(p.innerText);
  p.contentEditable=true;p.focus();
}
function prevCode(id){
  if(codeVersions[id].length>1){
    codeVersions[id].pop();
    document.querySelector("#"+id+" pre").innerText=
      codeVersions[id][codeVersions[id].length-1];
  }
}

/* ===============================
   SEND MESSAGE
================================ */
async function sendMessage(){
  if(!activeChat) return alert("Create or open a chat first");
  const t=chatInput.value.trim();
  if(!t||streaming) return;

  messages.push({role:"user",content:t});
  chatInput.value="";renderChat();

  const ai={role:"ai",content:""};
  messages.push(ai);renderChat();

  streaming=true;sendBtn.innerText="Typing‚Ä¶";

  try{
    const res=await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+getAPIKey()
      },
      body:JSON.stringify({
        model:"gpt-4o-mini",
        messages:messages.filter(m=>m.role!=="ai")
      })
    });
    const j=await res.json();
    ai.content=j.choices[0].message.content;
  }catch{
    ai.content="‚ö† Error";
  }

  streaming=false;sendBtn.innerText="Send";
  activeChat.messages=messages;
  saveChats();renderChat();
}
</script>
<script src="/Quizzone/pwa.js"></script>
</body>
</html>
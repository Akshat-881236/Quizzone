<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QuizzoneAI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="/Quizzone/manifest.json">
<meta name="theme-color" content="#2563eb">

<style>
:root{
--bg:#eef4ff;--panel:#ffffff;--accent:#2563eb;--danger:#ef4444;
--text:#0f172a;--border:#c7d2fe;--dark:#020617
}
*{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",Arial}
body{background:linear-gradient(135deg,#e0ecff,#f6fbff);min-height:100vh;overflow-y:auto;color:var(--text)}

.app{display:grid;grid-template-columns:300px 1fr;min-height:100vh}
.app.full{grid-template-columns:1fr}
.sidebar{background:var(--panel);border-right:1px solid var(--border);overflow-y:auto}
.sidebar.hide{display:none}

.main{display:flex;flex-direction:column;height:100vh;min-height:0}

.header{height:64px;flex-shrink:0;background:linear-gradient(90deg,var(--accent),#3b82f6);color:#fff;
display:flex;align-items:center;justify-content:space-between;padding:0 16px}
.left,.right{display:flex;align-items:center;gap:12px}
.avatar{width:40px;height:40px;border-radius:50%;border:2px solid #fff;object-fit:cover;cursor:pointer}

.brand{font-size:22px;font-weight:800;color:var(--accent);margin:10px 0}
.nav button{width:100%;padding:12px;margin:6px 0;border:none;border-radius:10px;background:#f1f5ff;cursor:pointer;text-align:left}
.nav button.active{background:var(--accent);color:#fff}
.history-item{padding:10px;border-radius:8px;background:#eef2ff;margin-bottom:6px;cursor:pointer}

.view{flex:1;display:none;padding:14px;min-height:0;overflow:hidden}
.view.active{display:flex;flex-direction:column}

.chat-window{flex:1;background:var(--panel);border:1px solid var(--border);border-radius:16px;
padding:14px;overflow-y:auto;overscroll-behavior:contain}
.msg{max-width:82%;padding:12px;border-radius:14px;margin-bottom:10px;white-space:pre-wrap;word-break:break-word}
.msg.user{background:#dbeafe;margin-left:auto}
.msg.ai{background:#fff;border:1px solid var(--border)}

.input-bar{display:flex;gap:8px;margin-top:10px;flex-shrink:0}
textarea{flex:1;min-height:56px;max-height:160px;resize:vertical;padding:12px;border-radius:12px;border:1px solid var(--border)}
.btn{padding:10px 16px;border:none;border-radius:10px;cursor:pointer;font-weight:600}
.primary{background:var(--accent);color:#fff}
.secondary{background:#e5e7ff}
.danger{background:var(--danger);color:#fff}

.codeBox{background:var(--dark);color:#e5e7eb;border-radius:12px;padding:12px;margin-top:10px;position:relative}
.codeTools{position:absolute;top:8px;right:8px;display:flex;gap:6px}
.codeTools button{padding:4px 6px;border-radius:6px;font-size:11px}

@media(max-width:1024px){
.app{grid-template-columns:1fr}
.sidebar{position:absolute;z-index:20;height:100%}
}
</style>
</head>

<body>

<script>
const ACTIVE_USER=JSON.parse(localStorage.getItem("ActiveQuizzoneUser"));
if(!ACTIVE_USER){location.href="/Quizzone/Home/SignIn.htm";}
</script>

<div class="app full" id="app">

<aside class="sidebar hide" id="sidebar">
  <div style="padding:16px">
    <img id="sideAvatar" class="avatar" onclick="toggleSidebar()">
    <div class="brand">QuizzoneAI</div>
    <div class="nav">
      <button onclick="switchView('chat',this)">Chat</button>
      <button onclick="switchView('about',this)">About</button>
    </div>
    <div style="margin-top:10px">
      <strong>Chats</strong>
      <div id="historyList"></div>
    </div>
  </div>
</aside>

<div class="main">
<header class="header">
  <div class="left">
    <img id="headAvatar" class="avatar" onclick="toggleSidebar()">
    <strong id="username"></strong>
  </div>
  <div class="right">
    <span id="tokenMeter">0</span>
    <button class="btn danger" onclick="logout()">Logout</button>
  </div>
</header>

<section class="view active" id="view-chat">
  <button class="btn primary" onclick="createChat()">+ New Chat</button>
  <div class="chat-window" id="chatWindow"></div>
  <div class="input-bar">
    <input type="file" id="fileInput" multiple>
    <textarea id="chatInput" placeholder="Enter = send | Shift+Enter = new line"></textarea>
    <button class="btn primary" onclick="sendMessage()">Send</button>
    <button class="btn secondary" onclick="startVoice()">üé§</button>
  </div>
</section>

<section class="view" id="view-about">
  <div class="chat-window">
    <h3>QuizzoneAI</h3>
    <p>Owner: <b>Akshat</b></p>
    <p>
      <a href="https://akshat-881236.github.io/Portfolio-881236/" target="_blank">Portfolio</a><br>
      <a href="https://github.com/Akshat-881236" target="_blank">GitHub</a><br>
      <a href="https://linkedin.com" target="_blank">LinkedIn</a>
    </p>
  </div>
</section>
</div>
</div>

<script>
username.innerText=ACTIVE_USER.username||"User";
headAvatar.src=sideAvatar.src=ACTIVE_USER.photo||"/Quizzone/Assets/default-user.png";

/* OPENAI API SPLIT */
const PART1="sk-svcacct-1bXYaWfnuaoCOjTByMxkXyGOT8aVmosQRyzfW-";
const PART2="KoAHXZ2JjuV14PCiYCz6pyB-f-1oQWfQDR3wT3BlbkFJtWDjmN_SlK6LYUtNJWOliwuQEr";
const PART3="nSMks8QQvSwnPJZOWt1VqqaEN-pBYJOHcL5R6cHSg5Sz62IA";
const API_KEY=PART1+PART2+PART3;

/* PREDEFINED LONG RESPONSES */
const PREDEFINED=[
{k:["creator","owner"],r:`QuizzoneAI is created by Akshat as the intelligence layer of Quizzone.
Portfolio: https://akshat-881236.github.io/Portfolio-881236/
GitHub: https://github.com/Akshat-881236
LinkedIn: https://linkedin.com`},
{k:["fee"],r:`Fee Portal (Demo Project):
https://akshat-881236.github.io/Key-of-Success/
A sample institutional fee management system.`},
{k:["portfolio"],r:`Explore projects and skills:
https://akshat-881236.github.io/Portfolio-881236/`}
];

let chats=JSON.parse(localStorage.getItem("QA_CHATS")||"[]");
let activeChat=null;
let tokens=0;

function toggleSidebar(){sidebar.classList.toggle("hide");app.classList.toggle("full");}
function switchView(v){document.querySelectorAll(".view").forEach(x=>x.classList.remove("active"));document.getElementById("view-"+v).classList.add("active");}

function createChat(){
const t=prompt("Chat title");if(!t)return;
activeChat={id:Date.now(),title:t,messages:[]};
chats.push(activeChat);save();render();renderHistory();
}

function render(){
chatWindow.innerHTML="";
if(!activeChat)return;
activeChat.messages.forEach(m=>{
const d=document.createElement("div");
d.className="msg "+m.role;
d.innerHTML=parse(m.content);
chatWindow.appendChild(d);
});
chatWindow.scrollTop=chatWindow.scrollHeight;
}

function renderHistory(){
historyList.innerHTML="";
chats.forEach(c=>{
const d=document.createElement("div");
d.className="history-item";
d.innerText=c.title;
d.onclick=()=>{activeChat=c;render();}
historyList.appendChild(d);
});
}

function parse(t){
return t.replace(/```html([\s\S]*?)```/g,(m,c)=>codeBox(c));
}

function codeBox(c){
const id="c"+Math.random().toString(36).slice(2);
return `<div class="codeBox" id="${id}">
<div class="codeTools">
<button onclick="copy('${id}')">üìã</button>
<button onclick="run('${id}')">‚ñ∂</button>
<button onclick="edit('${id}')">‚úè</button>
</div>
<pre>${c.replace(/</g,"&lt;")}</pre></div>`;
}

function copy(id){navigator.clipboard.writeText(document.querySelector("#"+id+" pre").innerText)}
function edit(id){const p=document.querySelector("#"+id+" pre");p.contentEditable=true;p.focus()}
function run(id){const b=document.getElementById(id);b.innerHTML=b.querySelector("pre").innerText}

function localAnswer(q){
q=q.toLowerCase();
for(const e of PREDEFINED){if(e.k.some(x=>q.includes(x)))return e.r}
return null;
}

function sendMessage(){
if(!activeChat){alert("Create chat first");return}
const t=chatInput.value.trim();if(!t)return;
activeChat.messages.push({role:"user",content:t});
chatInput.value="";render();

const l=localAnswer(t);
if(l){
activeChat.messages.push({role:"ai",content:l});
render();save();return;
}

fetchOpenAI(t);
}

async function fetchOpenAI(prompt){
const ai={role:"ai",content:""};
activeChat.messages.push(ai);
render();
try{
const res=await fetch("https://api.openai.com/v1/responses",{
method:"POST",
headers:{
"Content-Type":"application/json",
"Authorization":"Bearer "+API_KEY
},
body:JSON.stringify({
model:"gpt-4.1-mini",
input:prompt
})
});
const data=await res.json();
let out=data.output_text||"";
if(!out&&data.output?.[0]?.content){
data.output[0].content.forEach(c=>{if(c.type==="output_text")out+=c.text});
}
ai.content=out||"No response from AI.";
render();save();
}catch{
ai.content="AI service unreachable from browser.";
render();save();
}
}

fileInput.addEventListener("change",()=>{
if(!activeChat)return;
[...fileInput.files].forEach(f=>{
activeChat.messages.push({role:"ai",content:`File uploaded: ${f.name}`});
});
render();fileInput.value="";
});

function startVoice(){
const r=new webkitSpeechRecognition();
r.onresult=e=>{chatInput.value=e.results[0][0].transcript};
r.start();
}

function save(){localStorage.setItem("QA_CHATS",JSON.stringify(chats))}
chatInput.addEventListener("keydown",e=>{
if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}
});
function logout(){localStorage.removeItem("ActiveQuizzoneUser");location.href="/Quizzone/Home/SignIn.htm"}

renderHistory();
</script>
</body>
</html>
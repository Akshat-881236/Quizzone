<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quizzone | Settings</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;background:#eef3ff;font-family:"Segoe UI",Arial}
.settings-box{
  width:90%;max-width:900px;background:#fff;margin:60px auto;
  padding:25px;border-radius:14px;
  box-shadow:0 6px 25px rgba(0,0,0,.25)
}
h2{color:#007bff}
.section-title{margin-top:28px;font-size:20px;color:#005fcc}
input{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:1px solid #aaa}
button{padding:12px 18px;background:#007bff;border:none;color:white;
  font-size:16px;border-radius:8px;cursor:pointer}
button:hover{background:#005fcc}
.photo-preview{
  width:100px;height:100px;border-radius:12px;
  border:2px solid #007bff;object-fit:cover
}
.meter{height:8px;border-radius:6px;background:#ddd;margin-bottom:10px}
.meter span{display:block;height:100%;width:0;background:red;border-radius:6px}
.warning{color:red;font-size:13px}
.success{color:green;font-size:13px}
</style>
</head>
<script src="/Quizzone/Global/loader.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/MITLicense-Term-of-Use--Privacy.min.js"></script>
<script src="https://akshat-881236.github.io/sitemapjs/breadcrumb.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/redirect.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/akshatnetworkhub.min.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/tracker.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/trackermeta.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/ui.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/index.js"></script>
<script src="https://akshat-881236.github.io/TrackerJS/akshat-add-nav.js"></script>
<body onload="pushData()">
<script src="/Quizzone/Global/loader.js"></script>

<div class="settings-box">
<h2>Account Settings</h2>

<label><input type="checkbox" id="privacyConsent"> I agree to Privacy Policy & Data Usage</label>

<div class="section-title">Edit Profile</div>
<img id="photoPrev" class="photo-preview">
<input type="file" id="newPhoto" accept="image/*" onchange="previewPhoto()">
<input id="username">
<input id="fatherName">
<input id="dob" type="date">
<input id="email" disabled>
<input id="contact">
<input id="address">
<button onclick="updateProfile()">Save Profile</button>

<div class="section-title">Change Password</div>
<input type="password" id="oldPass" placeholder="Old Password">
<input type="password" id="newPass" placeholder="New Password" oninput="checkStrength()">
<div class="meter"><span id="strengthBar"></span></div>
<input type="password" id="confirmPass" placeholder="Confirm Password">
<button onclick="sendOTP()">Send OTP</button>
<input id="otpInput" placeholder="Enter OTP">
<button onclick="changePassword()">Update Password</button>

<div class="section-title">Danger Zone (GDPR)</div>
<p class="warning">
Deleting account will permanently remove all data. This cannot be undone.
</p>
<button style="background:#e60000" onclick="deleteAccount()">Delete My Account</button>
</div>

<script>
/* ================= LOAD ================= */
let user = JSON.parse(localStorage.getItem("ActiveQuizzoneUser"));
let users = JSON.parse(localStorage.getItem("QuizzoneUsersDB"))||[];
let audits = JSON.parse(localStorage.getItem("QuizzoneAuditLogs"))||[];

if(!user){alert("Login required");location.href="/Quizzone/Home/SignIn.htm"}

photoPrev.src=user.photo;
username.value=user.username;
fatherName.value=user.fatherName;
dob.value=user.dob;
email.value=user.email;
contact.value=user.contact;
address.value=user.address;
privacyConsent.checked=user.privacyConsent||false;

/* ================= HELPERS ================= */
function now(){return new Date().toISOString()}
function log(action,source){
  audits.push({email:user.email,action,source,time:now()});
  localStorage.setItem("QuizzoneAuditLogs",JSON.stringify(audits));
}
function age(d){
  let a=new Date().getFullYear()-new Date(d).getFullYear();
  return a;
}
function imgSig(b){let h=0;for(let i=0;i<b.length;i+=60){h=((h<<5)-h)+b.charCodeAt(i)}return h}

/* ================= PHOTO ================= */
function previewPhoto(){
  let f=newPhoto.files[0];
  if(f) photoPrev.src=URL.createObjectURL(f);
}

/* ================= PROFILE ================= */
function updateProfile(){
  if(!privacyConsent.checked) return alert("Consent required");
  if(age(dob.value)<18) return alert("Age must be 18+");

  let dup=users.find(u=>u.email!==user.email &&
    (u.contact===contact.value||
     (u.username===username.value&&u.dob===dob.value)));
  if(dup) return alert("Duplicate account detected");

  function save(photo){
    if(photo){
      let sig=imgSig(photo);
      if(users.find(u=>u.photoSignature===sig && u.email!==user.email))
        return alert("Photo matches another account");
      user.photo=photo;user.photoSignature=sig;
    }
    Object.assign(user,{
      username:username.value.trim(),
      fatherName:fatherName.value.trim(),
      dob:dob.value,
      contact:contact.value,
      address:address.value,
      privacyConsent:true
    });
    users[users.findIndex(u=>u.email===user.email)]=user;
    localStorage.setItem("ActiveQuizzoneUser",JSON.stringify(user));
    localStorage.setItem("QuizzoneUsersDB",JSON.stringify(users));
    log("Profile Updated","Settings");
    alert("Profile Updated");
  }

  let f=newPhoto.files[0];
  if(f){let r=new FileReader();r.onload=e=>save(e.target.result);r.readAsDataURL(f);}
  else save(null);
}

/* ================= PASSWORD ================= */
let otpCode=null;
function checkStrength(){
  let p=newPass.value,bar=strengthBar;
  let s=0;
  if(p.length>=8)s++;
  if(/[A-Z]/.test(p))s++;
  if(/[0-9]/.test(p))s++;
  if(/[@$!%*?&]/.test(p))s++;
  bar.style.width=(s*25)+"%";
  bar.style.background=["red","orange","yellow","blue","green"][s];
}

function sendOTP(){
  otpCode=Math.floor(100000+Math.random()*900000).toString();
  alert("OTP (mock): "+otpCode);
}

function changePassword(){
  if(user.accountLock?.until && Date.now()<user.accountLock.until)
    return alert("Account locked");

  if(oldPass.value!==user.password){
    user.failedAttempts=(user.failedAttempts||0)+1;
    if(user.failedAttempts>=3){
      user.accountLock={until:Date.now()+72*60*60*1000};
      alert("Account locked for 72 hours");
    }
    localStorage.setItem("ActiveQuizzoneUser",JSON.stringify(user));
    return;
  }

  if(otpInput.value!==otpCode) return alert("Invalid OTP");
  if(newPass.value!==confirmPass.value) return alert("Mismatch");

  user.password=newPass.value;
  user.failedAttempts=0;
  user.accountLock=null;
  users[users.findIndex(u=>u.email===user.email)]=user;
  localStorage.setItem("ActiveQuizzoneUser",JSON.stringify(user));
  localStorage.setItem("QuizzoneUsersDB",JSON.stringify(users));
  log("Password Changed","Settings");
  alert("Password Updated");
}

/* ================= GDPR DELETE ================= */
function deleteAccount(){
  if(!confirm("This will permanently delete your account. Continue?")) return;
  users=users.filter(u=>u.email!==user.email);
  localStorage.setItem("QuizzoneUsersDB",JSON.stringify(users));
  log("Account Deleted","Settings");
  localStorage.removeItem("ActiveQuizzoneUser");
  alert("Account Deleted");
  location.href="/Quizzone/Home/SignUp.htm";
}
</script>
<script src="/Quizzone/pwa.js"></script>
</body>
</html>
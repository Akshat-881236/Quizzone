<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quizzone | Settings</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; background:#eef3ff; font-family:"Segoe UI",Arial; }

.settings-box{
    width:90%; max-width:900px;
    background:white; margin:80px auto;
    padding:25px; border-radius:14px;
    box-shadow:0 4px 20px rgba(0,0,0,0.2);
}

h2{ color:#007bff; }

.section-title{
    margin-top:28px; font-size:20px; color:#005fcc;
}

input{
    width:100%; padding:12px;
    margin:8px 0; border-radius:8px;
    border:1px solid #aaa;
}

button{
    padding:12px 18px; background:#007bff; border:none;
    color:white; font-size:16px;
    border-radius:8px; cursor:pointer;
}
button:hover{ background:#005fcc; }

.photo-preview{
    width:100px; height:100px;
    border-radius:12px; border:2px solid #007bff;
    object-fit:cover; display:block;
    margin-bottom:12px;
}
</style>
</head>
<body>

<script src="/Quizzone/Global/loader.js"></script>

<div class="settings-box">

    <h2>Account Settings</h2>

    <!-- EDIT PROFILE -->
    <div class="section-title">Edit Profile Information</div>

    <img id="photoPrev" class="photo-preview" />

    <label>Change Profile Photo</label>
    <input type="file" id="newPhoto" accept="image/*" onchange="previewNewPhoto()">

    <input type="text" id="username">
    <input type="text" id="fatherName">
    <input type="date" id="dob">
    <input type="email" id="email" disabled>
    <input type="text" id="contact">
    <input type="text" id="address">

    <button onclick="updateProfile()">Save Changes</button>

    <!-- PASSWORD -->
    <div class="section-title">Change Password</div>
    <input type="password" id="oldPass" placeholder="Old Password">
    <input type="password" id="newPass" placeholder="New Password">
    <input type="password" id="confirmPass" placeholder="Confirm New Password">
    <button onclick="changePassword()">Update Password</button>
</div>

<script>
// LOAD USER
let user = JSON.parse(localStorage.getItem("ActiveQuizzoneUser"));
if(!user){ alert("Please login first."); window.location.href="index.html"; }

document.getElementById("photoPrev").src = user.photo;
document.getElementById("username").value = user.username;
document.getElementById("fatherName").value = user.fatherName;
document.getElementById("dob").value = user.dob;
document.getElementById("email").value = user.email;
document.getElementById("contact").value = user.contact;
document.getElementById("address").value = user.address;

/* ------- PHOTO PREVIEW -------- */
function previewNewPhoto(){
    let file = document.getElementById("newPhoto").files[0];
    if(file){
        document.getElementById("photoPrev").src = URL.createObjectURL(file);
    }
}

/* ------- UPDATE PROFILE -------- */
function updateProfile(){
    let file = document.getElementById("newPhoto").files[0];

    function saveData(photoData){
        user.username = document.getElementById("username").value.trim();
        user.fatherName = document.getElementById("fatherName").value.trim();
        user.dob = document.getElementById("dob").value;
        user.contact = document.getElementById("contact").value.trim();
        user.address = document.getElementById("address").value.trim();
        if(photoData) user.photo = photoData;

        // Save active
        localStorage.setItem("ActiveQuizzoneUser", JSON.stringify(user));

        // Save global DB
        let all = JSON.parse(localStorage.getItem("QuizzoneUsersDB"));
        let idx = all.findIndex(u => u.email === user.email);
        all[idx] = user;
        localStorage.setItem("QuizzoneUsersDB", JSON.stringify(all));

        alert("Profile Updated Successfully!");
    }

    if(file){
        let reader = new FileReader();
        reader.onload = e => saveData(e.target.result);
        reader.readAsDataURL(file);
    } else {
        saveData(null);
    }
}

/* ------- CHANGE PASSWORD -------- */
function changePassword(){
    let oldP = document.getElementById("oldPass").value;
    let newP = document.getElementById("newPass").value;
    let conf = document.getElementById("confirmPass").value;

    if(oldP !== user.password){
        alert("Old password is incorrect!");
        return;
    }
    if(newP !== conf){
        alert("New passwords do not match!");
        return;
    }

    user.password = newP;

    localStorage.setItem("ActiveQuizzoneUser", JSON.stringify(user));

    let all = JSON.parse(localStorage.getItem("QuizzoneUsersDB"));
    let idx = all.findIndex(u => u.email === user.email);
    all[idx] = user;
    localStorage.setItem("QuizzoneUsersDB", JSON.stringify(all));

    alert("Password Updated Successfully!");
}
</script>

</body>
</html>